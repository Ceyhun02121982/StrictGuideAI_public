name: Dump Android project for AI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dump:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build metadata
        run: |
          mkdir -p upload/meta
          echo "sha=${GITHUB_SHA}"         >  upload/meta/build_info.txt
          echo "ref=${GITHUB_REF}"         >> upload/meta/build_info.txt
          echo "actor=${GITHUB_ACTOR}"     >> upload/meta/build_info.txt
          echo "repo=${GITHUB_REPOSITORY}" >> upload/meta/build_info.txt
          echo "date=$(date -u)"           >> upload/meta/build_info.txt

      - name: Collect sources & config
        run: |
          mkdir -p upload
          # корневые файлы
          cp -f settings.gradle*        upload/ 2>/dev/null || true
          cp -f build.gradle*           upload/ 2>/dev/null || true
          cp -f gradle.properties       upload/ 2>/dev/null || true
          cp -f local.properties        upload/ 2>/dev/null || true
          # модуль app
          mkdir -p upload/app
          cp -f app/build.gradle*       upload/app/ 2>/dev/null || true
          # Android манифесты
          mkdir -p upload/app/src/main
          cp -rf app/src/main/AndroidManifest.xml upload/app/src/main/ 2>/dev/null || true
          # Kotlin/Java исходники
          if [ -d app/src/main/java ]; then
            mkdir -p upload/app/src/main/java
            rsync -a --delete --prune-empty-dirs \
              --include="*/" --include="*.kt" --include="*.java" \
              --exclude="*" app/src/main/java/ upload/app/src/main/java/
          fi
          # Ресурсы: layout и остальное
          if [ -d app/src/main/res ]; then
            mkdir -p upload/app/src/main/res
            rsync -a --delete --prune-empty-dirs \
              --include="*/" --include="*.xml" \
              --exclude="*" app/src/main/res/ upload/app/src/main/res/
          fi
          # GitHub Actions
          mkdir -p upload/.github/workflows
          cp -rf .github/workflows/*.yml upload/.github/workflows/ 2>/dev/null || true
          # Отчёты сборок, если есть
          if [ -d app/build/reports ]; then
            mkdir -p upload/app/build/reports
            cp -rf app/build/reports/* upload/app/build/reports/ || true
          fi

      - name: Create tree listing
        run: |
          sudo apt-get update -y && sudo apt-get install -y tree
          tree upload > upload/meta/tree.txt || true

      - name: Upload for AI
        uses: actions/upload-artifact@v4
        with:
          name: android-project-for-ai
          path: upload
          retention-days: 15
