name: AI Code Review (static)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Install Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-34
            build-tools;35.0.0
            cmdline-tools;latest

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Только статпроверки: линт/компиляция «всухую» без сборки APK
      - name: Run lint (debug)
        id: lint
        run: |
          set -o pipefail
          ./gradlew --no-daemon :app:lintDebug | tee lint.log

      - name: Upload Lint artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-lint
          path: |
            lint.log
            app/build/reports/lint-results-debug.html
            app/build/reports/lint-results-debug.xml
          if-no-files-found: warn
          retention-days: 15

      # Если есть XML отчёт с ошибками — оставим комментарий в PR
      - name: Comment to PR when lint errors found
        if: always()
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ⚠️ Android Lint завершился со статусом **${{ job.status }}**.
            Посмотри артефакты `pr-lint` (HTML/XML) и `lint.log`.
            Если `job.status = failure`, в отчёте есть ошибки, блокирующие PR.
          repo-token: ${{ secrets.GITHUB_TOKEN }}
